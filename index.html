<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI SEO æ±ºç­–èˆ‡å…§å®¹è‡ªå‹•åŒ–å¹³å°</title>
    <script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/4356_RC01/embed_loader.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <style>
      .loader { border-top-color: #2563eb; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
      @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .checkbox-custom:checked + div { border-color: #4f46e5; background-color: #eff6ff; }
      .checkbox-custom:checked + div .check-icon { display: block; }
      
      .trend-widget-container { 
        width: 100%; 
        height: 400px; 
        margin-bottom: 1rem; 
        border-radius: 0.5rem; 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch; 
        background: #fff; 
        box-shadow: inset 0 1px 4px rgba(0,0,0,0.1); 
        border: 1px solid #e2e8f0;
      }
      .trend-widget-container iframe { 
        width: 100% !important; 
        min-height: 100% !important; 
        border: none; 
      }
      .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
  </head>
  <body class="bg-slate-50 p-3 md:p-6 font-sans text-gray-800 pb-32">
    <div class="max-w-3xl mx-auto bg-white p-5 md:p-8 rounded-2xl shadow-xl border border-gray-100">
      
      <div class="text-center mb-6">
        <h1 class="text-2xl md:text-3xl font-extrabold mb-2 text-gray-900">ğŸš€ AI ä¼æ¥­ç´š SEO å…§å®¹æ±ºç­–çŸ©é™£</h1>
        <p class="text-sm text-gray-500 flex flex-col space-y-1">
          <span>Phase 1ï¼šå¤§æ•¸æ“šé ä¼°</span>
          <span class="font-bold text-indigo-600">Phase 1.5ï¼šGKP çœŸå¯¦æ•¸æ“šæ”¶æ–‚</span>
          <span>Phase 2ï¼šè·¨é€šè·¯å…§å®¹ç”Ÿæˆ</span>
        </p>
      </div>

      <div id="systemToast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 z-50 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm transition-opacity duration-300 w-11/12 max-w-md text-center"></div>

      <div class="flex flex-col space-y-4 mb-8 bg-indigo-50/50 p-5 rounded-xl border border-indigo-100">
        <div class="flex flex-col space-y-2">
          <label class="text-sm font-bold text-gray-700">ç”¢æ¥­ / ç”¢å“ / æœå‹™</label>
          <input type="text" id="industry" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-600 outline-none" placeholder="ä¾‹å¦‚ï¼šç‡Ÿé¤Šå¸«æ¸›é‡ã€å“ç‰Œé¡§å•...">
        </div>
        
        <div class="flex flex-col space-y-2">
          <label class="text-sm font-bold text-gray-700">å®¢æˆ¶ç—›é» / æƒ…å¢ƒ</label>
          <input type="text" id="painPoint" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-600 outline-none" placeholder="ä¾‹å¦‚ï¼šèŠ±äº†éŒ¢æ²’æˆæ•ˆçš„è€é—†...">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="flex flex-col space-y-2">
            <label class="text-sm font-bold text-gray-700">ä¸»é—œéµå­—æ•¸é‡</label>
            <input type="number" id="mainCount" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-600 outline-none" value="4" min="1" max="10">
          </div>
          <div class="flex flex-col space-y-2">
            <label class="text-sm font-bold text-gray-700">é•·å°¾è©æ•¸é‡</label>
            <input type="number" id="longCount" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-600 outline-none" value="6" min="1" max="15">
          </div>
        </div>

        <button onclick="generateKeywords()" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-indigo-700 transition shadow-md mt-2">
          ğŸ” åŸ·è¡Œ Phase 1ï¼šAI å¤§æ•¸æ“šé ä¼°èˆ‡ç™¼æ•£
        </button>
      </div>

      <div id="loading1" class="hidden flex flex-col justify-center items-center my-12">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-indigo-500 h-12 w-12 mb-4"></div>
        <p class="text-indigo-600 text-sm font-bold animate-pulse text-center">Gemini æ­£åœ¨èª¿ç”¨å¤§æ•¸æ“šåˆ†æ...</p>
      </div>

      <div id="keywordResults" class="hidden flex flex-col space-y-6">
        
        <div class="bg-indigo-50 border border-indigo-200 p-5 rounded-xl shadow-sm flex flex-col space-y-4">
          <div>
            <h3 class="font-black text-indigo-900 mb-1 flex items-center text-lg"><span class="mr-2">ğŸ“Š</span> æ­¥é©Ÿ 1.5ï¼šGKP æ•¸æ“šå°æ ¡ (ä¸€éµè¤‡è£½å…¨éƒ¨å­—è©)</h3>
            <p class="text-sm text-indigo-700 leading-relaxed">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç³»çµ±å°‡è‡ªå‹•æå–ã€Œæ‰€æœ‰ä¸»é—œéµå­—ã€é•·å°¾é—œéµå­—åŠå…¶æ ¸å¿ƒæ‹†è§£è©ã€ï¼Œä¾›æ‚¨ç„¡ç¸«è²¼å…¥æŸ¥è©¢çœŸå¯¦æ•¸æ“šã€‚</p>
          </div>
          <button id="copyGKPBtn" onclick="copyAndOpenGKP()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-5 rounded-lg shadow-md transition flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            <span id="copyGKPText">è¤‡è£½å…¨éƒ¨æ ¸å¿ƒè©ä¸¦é–‹å•Ÿ Keyword Planner</span>
          </button>
        </div>

        <div class="bg-white border-2 border-dashed border-indigo-200 p-5 rounded-xl">
          <h3 class="text-lg font-bold text-indigo-900 mb-2">ğŸ“¥ å°‡ GKP æ•¸æ“šè²¼åœ¨æ­¤è™•</h3>
          <p class="text-xs text-gray-500 mb-4 leading-relaxed">æ”¯æ´ç›´æ¥è²¼ä¸Šæœ€é«˜ 5000 åˆ—è¡¨æ ¼æ•¸æ“šã€‚ç³»çµ±å°‡ç‚ºæ‚¨é è¦½ç¢ºèªç„¡èª¤å¾Œï¼ŒAI å†è‡ªå‹•æ¸…æ´—ã€æ¿ƒç¸®ï¼Œæ·˜é‡‘å‡ºæœ€é«˜å•†æ¥­åƒ¹å€¼çš„å­—è©ã€‚</p>
          <textarea id="gkpPasteArea" class="w-full h-32 rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-600 outline-none text-sm text-gray-700 mb-4" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè¡¨æ ¼... (éœ€åŒ…å«æ¨™é¡Œåˆ—ï¼Œä¾‹å¦‚ï¼šé—œéµå­—, å¹³å‡æ¯æœˆæœå°‹é‡...)"></textarea>
          
          <div id="gkpPreviewContainer" class="hidden mb-4 overflow-x-auto border border-gray-200 rounded-lg shadow-inner bg-gray-50 max-h-60">
            <table class="w-full text-xs text-left text-gray-600">
              <thead class="bg-indigo-100 text-indigo-900 sticky top-0 shadow-sm">
                <tr id="gkpPreviewHeaders"></tr>
              </thead>
              <tbody id="gkpPreviewBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>

          <button onclick="analyzeGKPDataFlow()" class="w-full bg-emerald-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-emerald-700 transition shadow-md">
            âœ¨ ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œè®“ AI åˆ†æç¯©é¸é»ƒé‡‘å­—è©
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 text-blue-800 text-xs p-3 rounded-lg shadow-sm leading-relaxed">
          <span class="font-bold">ğŸ’¡ è‡ªå‹•æ’åºï¼š</span> 1. è¶¨å‹¢æœ€é«˜ â¡ï¸ 2. ç«¶çˆ­æœ€ä½ â¡ï¸ 3. æœå°‹é‡æœ€å¤§ã€‚
        </div>

        <div class="flex flex-col space-y-4">
          <h2 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">ğŸ”¥ AI é ä¼° - ä¸»è¦é—œéµå­—</h2>
          <div id="mainKeywords" class="grid grid-cols-1 gap-5"></div>
        </div>

        <div class="flex flex-col space-y-4">
          <h2 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">ğŸ¯ AI é ä¼° - ç²¾æº–é•·å°¾é—œéµå­—</h2>
          <div id="longtailKeywords" class="grid grid-cols-1 gap-5"></div>
        </div>
      </div>

      <div id="loadingGkp" class="hidden flex flex-col justify-center items-center my-12 border-t border-gray-100 pt-8">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-emerald-500 h-12 w-12 mb-4"></div>
        <p class="text-emerald-600 text-sm font-bold animate-pulse text-center">æ­£åœ¨æ¸…æ´—é«˜é”åƒç­†æ•¸æ“šï¼Œæ·˜é‡‘ç²¾é¸ä¸­...</p>
      </div>

      <div id="gkpAnalyzedResults" class="hidden mt-8 pt-8 border-t-2 border-emerald-100 flex flex-col space-y-4">
        <h2 class="text-xl font-black text-emerald-800 mb-2 border-b border-emerald-200 pb-2">ğŸ’ GKP çœŸå¯¦æ•¸æ“šæ·˜é‡‘çµæœ</h2>
        <div id="gkpCardsContainer" class="grid grid-cols-1 gap-5"></div>
      </div>

      <div id="customKwSection" class="hidden mt-8 bg-indigo-50 border border-indigo-100 rounded-xl p-5 shadow-inner flex flex-col space-y-3">
        <h3 class="text-lg font-bold text-indigo-900 flex items-center"><span class="mr-2">âœï¸</span> æ–°å¢è‡ªè¨‚é—œéµå­—</h3>
        <input type="text" id="customKwInput" onkeydown="handleCustomKeyword(event)" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 outline-none text-sm" placeholder="è¼¸å…¥å­—è©å¾ŒæŒ‰ Enter...">
        <div id="customKwContainer" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <div id="loading2" class="hidden flex flex-col justify-center items-center my-12 pt-8 border-t border-gray-100">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-purple-500 h-12 w-12 mb-4"></div>
        <p class="text-purple-600 text-sm font-bold animate-pulse text-center">æ­£åœ¨æ§‹å»º 70 å¤§å…¨é€šè·¯ä½ˆå±€ææ¡ˆçŸ©é™£ (å« 30 ç¯‡æ’è¡Œ)...</p>
      </div>

      <div id="strategyResults" class="hidden mt-10 pt-10 border-t-2 border-dashed border-gray-200 flex flex-col space-y-8">
        <h2 class="text-2xl font-black text-indigo-900 text-center mb-2">ğŸ† Phase 2ï¼šå…¨é€šè·¯å…§å®¹çŸ©é™£</h2>
        
        <div class="flex flex-col">
          <h3 class="text-lg font-bold bg-gray-800 text-white p-3 rounded-t-lg">ğŸŒ å®˜æ–¹ç¶²ç«™ 10 å¤§ SEO ç­–ç•¥</h3>
          <div class="bg-gray-50 p-4 rounded-b-lg border border-gray-200 flex flex-col space-y-4">
            <div>
              <h4 class="font-bold text-gray-700 mb-1">æ¶æ§‹å»ºè­°ï¼š</h4>
              <p id="webArch" class="text-sm text-gray-600 leading-relaxed"></p>
            </div>
            <div>
              <h4 class="font-bold text-gray-700 mb-1">æ¨™ç±¤ä½ˆå±€ï¼š</h4>
              <p id="webSeo" class="text-sm text-gray-600 leading-relaxed"></p>
            </div>
            <div class="border-t pt-3 border-gray-200">
              <h4 class="font-bold text-gray-900 mb-2">ğŸš€ 10 é …å…·é«”åšæ³•ï¼š</h4>
              <ul id="webTactics" class="list-decimal pl-5 space-y-2 text-sm text-gray-700"></ul>
            </div>
          </div>
        </div>

        <div class="flex flex-col">
          <div class="bg-blue-600 text-white p-3 rounded-t-lg flex justify-between items-center">
            <h3 class="text-lg font-bold">âœï¸ éƒ¨è½æ ¼ 30 å¤§ä¼åŠƒ (ä¾è³ªé‡æ’å)</h3>
          </div>
          <div class="bg-blue-50/30 p-4 border-x border-blue-100 flex flex-col space-y-4" id="blogProposalsContainer"></div>
          <div class="bg-blue-100 border-b border-x border-blue-200 rounded-b-lg p-3 flex justify-between items-center">
            <button onclick="changeBlogPage(-1)" id="btnBlogPrev" class="text-sm font-bold bg-white text-blue-700 px-4 py-2 rounded shadow-sm hover:bg-blue-50 transition">ä¸Šä¸€é </button>
            <span class="text-sm font-bold text-blue-900">ç¬¬ <span id="blogCurrentPageTxt">1</span> / 3 é </span>
            <button onclick="changeBlogPage(1)" id="btnBlogNext" class="text-sm font-bold bg-white text-blue-700 px-4 py-2 rounded shadow-sm hover:bg-blue-50 transition">ä¸‹ä¸€é </button>
          </div>
        </div>

        <div class="flex flex-col">
          <div class="bg-pink-600 text-white p-3 rounded-t-lg flex justify-between items-center">
            <h3 class="text-lg font-bold">ğŸ“± FB/IG ç¤¾ç¾¤ 30 å¤§ææ¡ˆ (ä¾æ½›åŠ›æ’å)</h3>
          </div>
          <div class="bg-pink-50/30 p-4 border-x border-pink-100 flex flex-col space-y-4" id="socialProposalsContainer"></div>
          <div class="bg-pink-100 border-b border-x border-pink-200 rounded-b-lg p-3 flex justify-between items-center">
            <button onclick="changeSocialPage(-1)" id="btnSocialPrev" class="text-sm font-bold bg-white text-pink-700 px-4 py-2 rounded shadow-sm hover:bg-pink-50 transition">ä¸Šä¸€é </button>
            <span class="text-sm font-bold text-pink-900">ç¬¬ <span id="socialCurrentPageTxt">1</span> / 3 é </span>
            <button onclick="changeSocialPage(1)" id="btnSocialNext" class="text-sm font-bold bg-white text-pink-700 px-4 py-2 rounded shadow-sm hover:bg-pink-50 transition">ä¸‹ä¸€é </button>
          </div>
        </div>
      </div>
      
      <div id="errorBox" class="hidden text-red-500 bg-red-50 p-5 rounded-xl border border-red-200 mt-6 font-bold text-sm text-center leading-relaxed"></div>
    </div>

    <div id="actionActionBar" class="fixed bottom-0 left-0 w-full bg-white border-t shadow-[0_-10px_30px_rgba(0,0,0,0.15)] p-4 transform translate-y-full transition-transform duration-300 flex flex-col justify-center items-center z-50">
      <div class="flex flex-col w-full max-w-3xl mx-auto space-y-2">
        <span class="text-gray-700 font-bold text-center text-sm">å·²é¸æ“‡ <span id="selectedCount" class="text-indigo-600 text-lg font-black">0</span> å€‹é—œéµå­—</span>
        <button onclick="generateStrategy()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black py-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-sm md:text-base">
          âš¡ ç«‹å³ç”Ÿæˆ 70 é …å…¨é€šè·¯å…§å®¹çŸ©é™£ (å«30ç¯‡æ’è¡Œ)
        </button>
      </div>
    </div>

    <script type="text/javascript">
      // ğŸŒŸ é€™è£¡å¡«å…¥ä½ ç™¼å¸ƒçš„ Google Apps Script Web App ç¶²å€
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyAUUaUK4aHN1EJ8TLIQMTeGC-XFmWyUPeiOBayNDeuSdV3tpFKg0zNzkPz0aF3SfhwKg/exec';

      let selectedKeywordsList = [];
      let customKeywordsList = []; 
      let allGeneratedKeywordsForGKP = []; 
      let trendWidgetIdCounter = 0; 
      
      let parsedGKPData = []; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜è§£æå¾Œçš„ GKP é™£åˆ—

      let globalBlogData = [];
      let globalSocialData = [];
      let currentBlogPage = 1;
      let currentSocialPage = 1;
      const itemsPerPage = 10;

      // ğŸ‘‡ æ–°å¢ï¼šç›£è½è²¼ä¸Šå€åŸŸçš„å…§å®¹è®ŠåŒ–ï¼Œè‡ªå‹•å»ºç«‹é è¦½è¡¨æ ¼
      document.getElementById('gkpPasteArea').addEventListener('input', function(e) {
        const rawData = e.target.value.trim();
        const container = document.getElementById('gkpPreviewContainer');
        const thead = document.getElementById('gkpPreviewHeaders');
        const tbody = document.getElementById('gkpPreviewBody');

        if (!rawData) {
          container.classList.add('hidden');
          parsedGKPData = [];
          return;
        }

        // ä¾ç…§æ›è¡Œèˆ‡ Tab åˆ‡å‰²å‡ºçœŸå¯¦è¡¨æ ¼é™£åˆ—
        const rows = rawData.split('\n').map(row => row.split('\t'));
        if (rows.length < 2) return;

        const headers = rows[0];
        thead.innerHTML = headers.map(h => `<th class="px-3 py-2 whitespace-nowrap font-bold">${h.trim()}</th>`).join('');

        // åªé è¦½å‰ 10 ç­†ï¼Œé¿å…ç•«é¢éé•·
        const previewRows = rows.slice(1, 11);
        tbody.innerHTML = previewRows.map(row => {
          return `<tr class="bg-white hover:bg-indigo-50 transition">` + 
                 row.map(cell => `<td class="px-3 py-2 whitespace-nowrap">${cell ? cell.trim() : '-'}</td>`).join('') + 
                 `</tr>`;
        }).join('');
        
        if (rows.length > 11) {
          tbody.innerHTML += `<tr><td colspan="${headers.length}" class="px-3 py-2 text-center text-indigo-500 font-bold bg-indigo-50/50">...ä¸‹æ–¹é‚„æœ‰ ${rows.length - 11} ç­†è³‡æ–™å·²æˆåŠŸè®€å–ï¼ˆéš±è—é è¦½ï¼‰</td></tr>`;
        }

        container.classList.remove('hidden');

        // å°‡æ‰€æœ‰è³‡æ–™è½‰æ›æˆ Key-Value ç‰©ä»¶é™£åˆ—å­˜ä¸‹ä¾†ï¼Œç­‰å¾…å‚³çµ¦å¾Œç«¯
        parsedGKPData = rows.slice(1).map(row => {
          let obj = {};
          headers.forEach((header, index) => {
            obj[header.trim()] = row[index] ? row[index].trim() : '';
          });
          return obj;
        }).filter(obj => obj['é—œéµå­—'] && obj['é—œéµå­—'] !== ''); // éæ¿¾ç©ºè¡Œ
      });

      function showToast(message, isError) {
        const toast = document.getElementById('systemToast');
        toast.innerText = message;
        toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 z-50 px-5 py-3 rounded-full shadow-2xl font-bold text-sm transition-opacity duration-300 w-11/12 max-w-md text-center text-white';
        if(isError) {
            toast.classList.add('bg-red-600');
        } else {
            toast.classList.add('bg-gray-900');
        }
        toast.classList.remove('hidden');
        setTimeout(function(){ toast.classList.add('hidden'); }, 4000);
      }

      function copyAndOpenGKP() {
        if (allGeneratedKeywordsForGKP.length === 0) return;
        const textToCopy = allGeneratedKeywordsForGKP.join(String.fromCharCode(10)); 
        
        navigator.clipboard.writeText(textToCopy).then(function() {
          const btnText = document.getElementById('copyGKPText');
          const originalText = btnText.innerText;
          btnText.innerText = 'âœ… å…¨éƒ¨è¤‡è£½æˆåŠŸï¼è«‹è²¼å…¥æ–°åˆ†é ';
          document.getElementById('copyGKPBtn').classList.replace('bg-indigo-600', 'bg-green-600');
          
          setTimeout(function() {
            btnText.innerText = originalText;
            document.getElementById('copyGKPBtn').classList.replace('bg-green-600', 'bg-indigo-600');
          }, 4000);

          window.open('https://ads.google.com/aw/keywordplanner/ideas/new', '_blank');
        }).catch(function(err) {
          showToast('è‡ªå‹•è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', true);
        });
      }

      function copyGeneratedContent(elementId, btnElement) {
        const contentDiv = document.getElementById(elementId);
        if (!contentDiv) return;

        try {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(contentDiv);
          selection.removeAllRanges();
          selection.addRange(range);

          document.execCommand('copy');
          selection.removeAllRanges();

          const originalHTML = btnElement.innerHTML;
          btnElement.innerHTML = 'âœ… è¤‡è£½æˆåŠŸï¼(å·²ä¿ç•™æ’ç‰ˆ)';
          btnElement.classList.replace('bg-indigo-600', 'bg-green-600');
          btnElement.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
          
          setTimeout(function() {
            btnElement.innerHTML = originalHTML;
            btnElement.classList.replace('bg-green-600', 'bg-indigo-600');
            btnElement.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
          }, 2000);
        } catch(err) {
          showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…¨é¸è¤‡è£½ã€‚', true);
        }
      }

      function renderInlineTrends(keywordEncoded, timeRange, containerId) {
        const keyword = decodeURIComponent(keywordEncoded);
        const container = document.getElementById(containerId);
        
        container.classList.remove('hidden');
        container.innerHTML = '<div class="w-full p-6 flex flex-col items-center justify-center bg-indigo-50/30 rounded-lg border border-indigo-100 mt-4 shadow-sm"><div class="loader ease-linear rounded-full border-2 border-t-2 border-indigo-500 h-8 w-8 mb-3"></div><span class="text-xs text-indigo-700 font-bold animate-pulse text-center leading-relaxed">æ­£åœ¨å‘ Google è«‹æ±‚å¤§æ•¸æ“š...<br>(åœ–è¡¨å°‡ä¾åºè¼‰å…¥ï¼Œè«‹ç¨å€™)</span></div>';

        const exploreQuery = "geo=TW&q=" + keywordEncoded + "&date=" + timeRange;
        const comparisonItem = [{"keyword": keyword, "geo": "TW", "time": timeRange}];
        
        setTimeout(function() {
          container.innerHTML = '<div class="mt-4 bg-slate-100 p-3 md:p-4 rounded-xl border border-slate-300 flex flex-col space-y-4 shadow-xl relative trends-panel-content"><div class="text-sm font-black text-indigo-900 border-b border-slate-300 pb-3 flex justify-between items-center sticky top-0 z-10"><span>ğŸ“Š ' + keyword + ' - å¯¦æ™‚æˆ°æƒ…é¢æ¿</span><button type="button" onclick="document.getElementById(\'' + containerId + '\').classList.add(\'hidden\'); event.stopPropagation();" class="text-xs bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded shadow-sm transition font-bold flex items-center">âœ– æ”¶åˆ</button></div><div class="flex flex-col space-y-4"><div class="trend-widget-container" id="' + containerId + '-ts"></div><div class="trend-widget-container" id="' + containerId + '-geo"></div><div class="trend-widget-container" id="' + containerId + '-topic"></div><div class="trend-widget-container" id="' + containerId + '-query"></div></div><button type="button" onclick="document.getElementById(\'' + containerId + '\').classList.add(\'hidden\'); event.stopPropagation();" class="w-full text-sm bg-slate-200 text-slate-700 hover:bg-slate-300 py-3 rounded shadow-sm transition font-bold mt-2">âï¸ é—œé–‰é¢æ¿</button></div>';

          try {
            setTimeout(function() { trends.embed.renderExploreWidgetTo(document.getElementById(containerId + "-ts"), "TIMESERIES", {"comparisonItem":comparisonItem,"category":0,"property":""}, {"exploreQuery":exploreQuery,"guestPath":"https://trends.google.com.tw:443/trends/embed/"}); }, 100);
            setTimeout(function() { trends.embed.renderExploreWidgetTo(document.getElementById(containerId + "-geo"), "GEO_MAP", {"comparisonItem":comparisonItem,"category":0,"property":""}, {"exploreQuery":exploreQuery,"guestPath":"https://trends.google.com.tw:443/trends/embed/"}); }, 900);
            setTimeout(function() { trends.embed.renderExploreWidgetTo(document.getElementById(containerId + "-topic"), "RELATED_TOPICS", {"comparisonItem":comparisonItem,"category":0,"property":""}, {"exploreQuery":exploreQuery,"guestPath":"https://trends.google.com.tw:443/trends/embed/"}); }, 1700);
            setTimeout(function() { trends.embed.renderExploreWidgetTo(document.getElementById(containerId + "-query"), "RELATED_QUERIES", {"comparisonItem":comparisonItem,"category":0,"property":""}, {"exploreQuery":exploreQuery,"guestPath":"https://trends.google.com.tw:443/trends/embed/"}); }, 2500);
          } catch (e) {
            container.innerHTML = '<div class="p-3 text-red-500 text-xs font-bold bg-red-50 rounded mt-2 text-center">åœ–è¡¨è¼‰å…¥å—åˆ°é™åˆ¶ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</div>';
          }
        }, 300);
      }

      function handleCustomKeyword(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const val = event.target.value.trim();
          if (val && customKeywordsList.indexOf(val) === -1) {
            customKeywordsList.push(val);
            renderCustomKeywords();
            updateActionBar();
          }
          event.target.value = '';
        }
      }

      function removeCustomKeyword(val) {
        customKeywordsList = customKeywordsList.filter(function(k) { return k !== val; });
        renderCustomKeywords();
        updateActionBar();
      }

      function renderCustomKeywords() {
        const container = document.getElementById('customKwContainer');
        container.innerHTML = customKeywordsList.map(function(kw) {
          return '<span class="inline-flex items-center bg-indigo-600 text-white text-xs font-bold px-3 py-2 rounded-full shadow-sm">' + kw + '<button type="button" onclick="removeCustomKeyword(\'' + kw + '\')" class="ml-2 hover:text-indigo-200 focus:outline-none font-bold">&times;</button></span>';
        }).join('');
      }

      function toggleKeyword(checkbox) {
        if (checkbox && checkbox.checked) {
          selectedKeywordsList.push(checkbox.value);
        } else if (checkbox) {
          selectedKeywordsList = selectedKeywordsList.filter(function(k) { return k !== checkbox.value; });
        }
        updateActionBar();
      }

      function updateActionBar() {
        const total = selectedKeywordsList.length + customKeywordsList.length;
        document.getElementById('selectedCount').innerText = total;
        const actionBar = document.getElementById('actionActionBar');
        if (total > 0) actionBar.classList.remove('translate-y-full');
        else actionBar.classList.add('translate-y-full');
      }

      function parseTrend(str) {
        if (!str) return 0;
        let match = str.match(new RegExp('([+-]?\\d+)'));
        if (match) return parseInt(match[0], 10);
        if (str.indexOf('å‡') !== -1 || str.indexOf('æˆé•·') !== -1) return 5;
        if (str.indexOf('é™') !== -1 || str.indexOf('è¡°é€€') !== -1) return -5;
        return 0;
      }
      function parseComp(str) {
        if (!str) return 2;
        if (str.indexOf('ä½') !== -1) return 1;
        if (str.indexOf('ä¸­') !== -1) return 2;
        if (str.indexOf('é«˜') !== -1) return 3;
        return 2;
      }
      function parseVol(str) {
        if (!str) return 0;
        let v = str.split(',').join('');
        if (v.indexOf('è¬') !== -1) {
          let m = v.match(new RegExp('(\\d+)è¬'));
          if (m) return parseInt(m[1], 10) * 10000;
        }
        let m = v.match(new RegExp('(\\d+)'));
        return m ? parseInt(m[0], 10) : 0;
      }
      
      function sortAlgorithm(arr) {
        return arr.sort(function(a, b) {
          let tA = parseTrend(a.metrics.trend_3m);
          let tB = parseTrend(b.metrics.trend_3m);
          if (tA !== tB) return tB - tA;
          let cA = parseComp(a.metrics.competition);
          let cB = parseComp(b.metrics.competition);
          if (cA !== cB) return cA - cB;
          let vA = parseVol(a.metrics.volume);
          let vB = parseVol(b.metrics.volume);
          return vB - vA;
        });
      }

      // æ”¹ç”¨ fetch å‘¼å«å¾Œç«¯ API
      function generateKeywords() {
        const industry = document.getElementById('industry').value;
        const painPoint = document.getElementById('painPoint').value;
        const mainCount = document.getElementById('mainCount').value;
        const longCount = document.getElementById('longCount').value;

        if(!industry || !painPoint) { showToast('è«‹å…ˆå¡«å¯«ç”¢æ¥­èˆ‡å®¢æˆ¶ç—›é»ï¼', true); return; }

        document.getElementById('loading1').classList.remove('hidden');
        document.getElementById('keywordResults').classList.add('hidden');
        document.getElementById('gkpAnalyzedResults').classList.add('hidden');
        document.getElementById('customKwSection').classList.add('hidden');
        document.getElementById('strategyResults').classList.add('hidden');
        document.getElementById('errorBox').classList.add('hidden');
        
        selectedKeywordsList = [];
        customKeywordsList = []; 
        allGeneratedKeywordsForGKP = []; 
        renderCustomKeywords();
        updateActionBar();

        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'generateKeywords', industry, painPoint, mainCount, longCount })
        })
        .then(response => response.text())
        .then(displayKeywords)
        .catch(showError);
      }

      function displayKeywords(responseString) {
        document.getElementById('loading1').classList.add('hidden');
        try {
          const data = JSON.parse(responseString);
          if(data.error) throw new Error(data.error);

          const sortedMain = sortAlgorithm([].concat(data.main_keywords));
          const sortedLong = sortAlgorithm([].concat(data.longtail_keywords));

          let extractionPool = [];
          
          data.main_keywords.forEach(function(item) {
            extractionPool.push({ word: item.keyword, metrics: item.metrics });
          });
          
          data.longtail_keywords.forEach(function(item) {
            extractionPool.push({ word: item.keyword, metrics: item.metrics });
            if (item.core_keywords && item.core_keywords.length > 0) {
              item.core_keywords.forEach(function(coreWord) {
                extractionPool.push({ word: coreWord, metrics: item.metrics });
              });
            }
          });

          extractionPool.sort(function(a, b) {
            let tA = parseTrend(a.metrics.trend_3m);
            let tB = parseTrend(b.metrics.trend_3m);
            if (tA !== tB) return tB - tA;
            let cA = parseComp(a.metrics.competition);
            let cB = parseComp(b.metrics.competition);
            if (cA !== cB) return cA - cB;
            let vA = parseVol(a.metrics.volume);
            let vB = parseVol(b.metrics.volume);
            return vB - vA;
          });

          let allWords = [];
          for (let i = 0; i < extractionPool.length; i++) {
            let w = extractionPool[i].word;
            if (allWords.indexOf(w) === -1) {
              allWords.push(w);
            }
          }
          
          allGeneratedKeywordsForGKP = allWords;

          document.getElementById('mainKeywords').innerHTML = sortedMain.map(function(k){ return createKeywordCard(k, 'main', false); }).join('');
          document.getElementById('longtailKeywords').innerHTML = sortedLong.map(function(k){ return createKeywordCard(k, 'long', false); }).join('');
          
          document.getElementById('keywordResults').classList.remove('hidden');
          document.getElementById('customKwSection').classList.remove('hidden');
        } catch (e) { 
          showError("AI å›å‚³çš„è³‡æ–™ç•°å¸¸ï¼Œå»ºè­°èª¿é™æ•¸é‡å†è©¦ä¸€æ¬¡ã€‚"); 
        }
      }

      function analyzeGKPDataFlow() {
        const pastedData = document.getElementById('gkpPasteArea').value;
        const industry = document.getElementById('industry').value;
        const painPoint = document.getElementById('painPoint').value;

        // ğŸ‘‡ æ”¹ç‚ºé©—è­‰è§£æå‡ºä¾†çš„é™£åˆ—æ˜¯å¦æœ‰è³‡æ–™
        if (!pastedData.trim() || parsedGKPData.length === 0) { 
          showToast('è«‹å…ˆè²¼ä¸Šå¾ Google Keyword Planner è¤‡è£½çš„å®Œæ•´è¡¨æ ¼æ•¸æ“šï¼', true); 
          return; 
        }
        
        document.getElementById('loadingGkp').classList.remove('hidden');
        document.getElementById('gkpAnalyzedResults').classList.add('hidden');
        document.getElementById('errorBox').classList.add('hidden');
        
        window.scrollTo({ top: document.getElementById('loadingGkp').offsetTop - 20, behavior: 'smooth' });

        // ğŸ‘‡ å°‡çµæ§‹åŒ–å¥½ä¸”æ²’éŒ¯çš„é™£åˆ— (parsedData) é€å‡ºçµ¦ GAS å¾Œç«¯
        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'analyzeGKPData', parsedData: parsedGKPData, industry, painPoint })
        })
        .then(response => response.text())
        .then(displayGkpResults)
        .catch(showError);
      }

      function displayGkpResults(responseString) {
        document.getElementById('loadingGkp').classList.add('hidden');
        try {
          const data = JSON.parse(responseString);
          if(data.error) throw new Error(data.error);

          const combinedGkp = [].concat((data.gkp_main || []), (data.gkp_longtail || []));
          
          document.getElementById('gkpCardsContainer').innerHTML = combinedGkp.map(function(k){ return createKeywordCard(k, 'gkp', true); }).join('');
          document.getElementById('gkpAnalyzedResults').classList.remove('hidden');
          
          window.scrollTo({ top: document.getElementById('gkpAnalyzedResults').offsetTop - 20, behavior: 'smooth' });

        } catch (e) {
          showError("GKP æ•¸æ“šè§£æå¤±æ•—ï¼Œè«‹ç¢ºä¿è²¼ä¸Šçš„æ˜¯å®Œæ•´çš„è¡¨æ ¼åŸå§‹æ–‡å­—ã€‚");
        }
      }

      function createKeywordCard(item, type, isGKP) {
        if(isGKP === undefined) isGKP = false;
        let trendsRowsHtml = '';
        const coreKeywordsArray = item.core_keywords && item.core_keywords.length > 0 ? item.core_keywords : [item.keyword];
        
        coreKeywordsArray.forEach(function(kw) {
          trendWidgetIdCounter++; 
          const containerId = "trends-dashboard-" + trendWidgetIdCounter;
          const encKw = encodeURIComponent(kw).split("'").join("%27");
          
          const btnStyle = "text-[11px] md:text-xs font-bold px-2 py-2 md:py-1.5 bg-white border border-gray-200 hover:bg-indigo-100 hover:text-indigo-700 hover:border-indigo-300 rounded shadow-sm transition flex-grow text-center";

          trendsRowsHtml += '<div class="bg-slate-50 p-3 rounded-lg mb-3 border border-slate-100 flex flex-col space-y-3"><span class="text-sm font-bold text-indigo-900 flex items-center"><span class="text-base mr-2">ğŸ”</span>' + kw + '</span><div class="flex flex-wrap gap-2"><button type="button" onclick="renderInlineTrends(\'' + encKw + '\', \'today 12-m\', \'' + containerId + '\'); event.preventDefault(); event.stopPropagation();" class="' + btnStyle + '">è¿‘ä¸€å¹´</button><button type="button" onclick="renderInlineTrends(\'' + encKw + '\', \'today 3-m\', \'' + containerId + '\'); event.preventDefault(); event.stopPropagation();" class="' + btnStyle + '">è¿‘ä¸‰æœˆ</button><button type="button" onclick="renderInlineTrends(\'' + encKw + '\', \'today 1-m\', \'' + containerId + '\'); event.preventDefault(); event.stopPropagation();" class="' + btnStyle + '">è¿‘ä¸€æœˆ</button><button type="button" onclick="renderInlineTrends(\'' + encKw + '\', \'now 7-d\', \'' + containerId + '\'); event.preventDefault(); event.stopPropagation();" class="' + btnStyle + '">è¿‘ä¸€é€±</button><button type="button" onclick="renderInlineTrends(\'' + encKw + '\', \'now 1-d\', \'' + containerId + '\'); event.preventDefault(); event.stopPropagation();" class="' + btnStyle + '">æœ¬æ—¥</button></div><div id="' + containerId + '" class="hidden w-full transition-all duration-300 trends-panel-wrapper" onclick="event.stopPropagation();"></div></div>';
        });

        let compColor = item.metrics.competition.indexOf('ä½') !== -1 ? 'text-green-700' : item.metrics.competition.indexOf('é«˜') !== -1 ? 'text-red-700' : 'text-yellow-700';
        let thirdMetricTitle = isGKP ? 'å¯¦æ™‚å‡ºåƒ¹' : 'é ä¼°è¶¨å‹¢';
        let thirdMetricValue = isGKP ? (item.metrics.bid || 'æœªæä¾›') : item.metrics.trend_3m;
        let thirdMetricColor = isGKP ? 'text-emerald-700' : ((thirdMetricValue.indexOf('+') !== -1 || thirdMetricValue.indexOf('å‡') !== -1) ? 'text-red-600' : 'text-blue-600');
        let cardBorderTheme = isGKP ? 'border-emerald-200 hover:border-emerald-400' : 'border-gray-100 hover:border-indigo-300';
        let iconColor = isGKP ? 'text-emerald-600' : 'text-indigo-600';
        let badgeHtml = isGKP ? '<span class="inline-block text-[10px] bg-emerald-100 text-emerald-800 px-2 py-1 rounded ml-1 align-top">âœ” çœŸå¯¦æ•¸æ“š</span>' : '';

        return '<label class="relative cursor-pointer block h-full w-full"><input type="checkbox" class="checkbox-custom absolute opacity-0 w-0 h-0" value="' + item.keyword + '" onchange="toggleKeyword(this)"><div class="bg-white border-2 ' + cardBorderTheme + ' rounded-xl p-4 md:p-5 transition flex flex-col space-y-4"><div class="absolute top-4 right-4 check-icon hidden ' + iconColor + '"><svg class="w-6 h-6 md:w-8 md:h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></div><div class="pr-8"><h3 class="text-lg md:text-xl font-black text-gray-900 leading-snug">' + item.keyword + badgeHtml + '</h3></div><div class="flex flex-col md:flex-row gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-inner"><div class="flex-1 flex justify-between md:flex-col md:items-center border-b md:border-b-0 md:border-r border-gray-200 pb-2 md:pb-0 md:pr-2"><span class="text-xs font-bold text-gray-500">æœå°‹é‡</span><span class="text-sm font-bold text-gray-700">' + item.metrics.volume + '</span></div><div class="flex-1 flex justify-between md:flex-col md:items-center border-b md:border-b-0 md:border-r border-gray-200 pb-2 md:pb-0 md:pr-2"><span class="text-xs font-bold text-gray-500">ç«¶çˆ­åº¦</span><span class="text-sm font-bold ' + compColor + '">' + item.metrics.competition + '</span></div><div class="flex-1 flex justify-between md:flex-col md:items-center"><span class="text-xs font-bold text-gray-500">' + thirdMetricTitle + '</span><span class="text-sm font-black ' + thirdMetricColor + '">' + thirdMetricValue + '</span></div></div><div class="text-sm text-gray-600 bg-indigo-50/30 p-3 rounded-lg"><span class="font-bold ' + iconColor + ' block mb-1">ğŸ’¡ åƒ¹å€¼è§£æï¼š</span>' + item.analysis + '</div><div class="border-t border-gray-100 pt-4"><span class="text-xs font-bold text-gray-500 mb-3 block flex items-center">é»æ“Šæ™‚é–“ï¼Œæ–¼ä¸‹æ–¹å±•é–‹ Google Trends é¢ é¢æ¿ï¼š</span><div class="flex flex-col space-y-2">' + trendsRowsHtml + '</div></div></div></label>';
      }

      function generateStrategy() {
        const finalKeywords = [].concat(selectedKeywordsList, customKeywordsList);
        
        if(finalKeywords.length === 0) {
          showToast('è«‹è‡³å°‘å‹¾é¸æˆ–è¼¸å…¥ä¸€å€‹ä½ˆå±€é—œéµå­—ï¼', true);
          return;
        }

        const industry = document.getElementById('industry').value;
        const painPoint = document.getElementById('painPoint').value;
        
        document.getElementById('actionActionBar').classList.add('translate-y-full');
        document.getElementById('strategyResults').classList.add('hidden');
        document.getElementById('loading2').classList.remove('hidden');
        
        window.scrollTo({ top: document.getElementById('loading2').offsetTop - 20, behavior: 'smooth' });

        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'generateContentStrategy', selectedKeywords: finalKeywords, industry, painPoint })
        })
        .then(response => response.text())
        .then(displayStrategy)
        .catch(showError);
      }

      function displayStrategy(responseString) {
        document.getElementById('loading2').classList.add('hidden');
        try {
          const data = JSON.parse(responseString);
          if(data.error) throw new Error(data.error);

          document.getElementById('webArch').innerText = data.website_strategy.architecture;
          document.getElementById('webSeo').innerText = data.website_strategy.seo_layout;
          if (data.website_strategy.top_10_tactics) {
            document.getElementById('webTactics').innerHTML = data.website_strategy.top_10_tactics.map(function(t){ return '<li class="pb-2 border-b border-gray-100 last:border-0">' + t + '</li>'; }).join('');
          }

          globalBlogData = data.blog_proposals || [];
          globalSocialData = data.social_proposals || [];
          
          currentBlogPage = 1;
          currentSocialPage = 1;

          renderBlogPage();
          renderSocialPage();

          document.getElementById('strategyResults').classList.remove('hidden');
          window.scrollTo({ top: document.getElementById('strategyResults').offsetTop - 20, behavior: 'smooth' });

        } catch (e) { 
          showError("AI å›å‚³çš„è³‡æ–™ç•°å¸¸ã€‚å› ç‚º 60 å€‹ææ¡ˆå­—æ•¸æ¥µå¤§ï¼Œè‹¥æŒçºŒå¤±æ•—è«‹å˜—è©¦é‡æ–°é»æ“Šç”Ÿæˆã€‚"); 
        }
      }

      function renderBlogPage() {
        const start = (currentBlogPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const currentData = globalBlogData.slice(start, end);
        const totalPages = Math.ceil(globalBlogData.length / itemsPerPage) || 1;

        document.getElementById('blogCurrentPageTxt').innerText = currentBlogPage;
        
        document.getElementById('btnBlogPrev').disabled = (currentBlogPage === 1);
        document.getElementById('btnBlogPrev').className = currentBlogPage === 1 ? "text-sm font-bold bg-gray-200 text-gray-400 px-4 py-2 rounded cursor-not-allowed" : "text-sm font-bold bg-white text-blue-700 px-4 py-2 rounded shadow-sm hover:bg-blue-50 transition";
        
        document.getElementById('btnBlogNext').disabled = (currentBlogPage === totalPages);
        document.getElementById('btnBlogNext').className = currentBlogPage === totalPages ? "text-sm font-bold bg-gray-200 text-gray-400 px-4 py-2 rounded cursor-not-allowed" : "text-sm font-bold bg-white text-blue-700 px-4 py-2 rounded shadow-sm hover:bg-blue-50 transition";

        document.getElementById('blogProposalsContainer').innerHTML = currentData.map(function(b, i) {
          const actualRank = start + i + 1; 
          const absIndex = start + i;
          const containerId = 'generated-blog-' + absIndex;
          
          return '<div class="bg-white p-4 rounded-lg shadow-sm border border-blue-100 flex flex-col space-y-3">' + 
            '<h4 class="font-black text-lg text-blue-900 leading-snug"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-2">Top ' + actualRank + ' æ¨è–¦</span><br class="md:hidden mt-2">' + b.title + '</h4>' + 
            '<p class="text-sm font-bold text-gray-500">' + b.subtitle + '</p>' + 
            '<p class="text-sm text-gray-700 leading-relaxed"><span class="font-bold text-blue-700 block mb-1">æ¶æ§‹ï¼š</span>' + b.outline + '</p>' + 
            '<p class="text-xs bg-blue-50 text-blue-800 p-3 rounded leading-relaxed"><span class="font-bold block mb-1">ğŸ”‘ é—œéµå­—ä½ˆå±€ï¼š</span>' + b.keyword_placement + '</p>' + 
            '<div class="pt-2 border-t border-blue-50">' + 
              '<button onclick="triggerContentGen(\'blog\', ' + absIndex + ', \'' + containerId + '\')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded shadow transition w-full md:w-auto">âœ¨ è®“ AI å¹«æˆ‘å¯«é€™ç¯‡æ–‡ç« </button>' + 
            '</div>' + 
            '<div id="' + containerId + '" class="hidden mt-3 trends-panel-wrapper"></div>' + 
          '</div>';
        }).join('');
      }

      function changeBlogPage(direction) {
        const totalPages = Math.ceil(globalBlogData.length / itemsPerPage) || 1;
        currentBlogPage += direction;
        if(currentBlogPage < 1) currentBlogPage = 1;
        if(currentBlogPage > totalPages) currentBlogPage = totalPages;
        renderBlogPage();
      }

      function renderSocialPage() {
        const start = (currentSocialPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const currentData = globalSocialData.slice(start, end);
        const totalPages = Math.ceil(globalSocialData.length / itemsPerPage) || 1;

        document.getElementById('socialCurrentPageTxt').innerText = currentSocialPage;
        
        document.getElementById('btnSocialPrev').disabled = (currentSocialPage === 1);
        document.getElementById('btnSocialPrev').className = currentSocialPage === 1 ? "text-sm font-bold bg-gray-200 text-gray-400 px-4 py-2 rounded cursor-not-allowed" : "text-sm font-bold bg-white text-pink-700 px-4 py-2 rounded shadow-sm hover:bg-pink-50 transition";
        
        document.getElementById('btnSocialNext').disabled = (currentSocialPage === totalPages);
        document.getElementById('btnSocialNext').className = currentSocialPage === totalPages ? "text-sm font-bold bg-gray-200 text-gray-400 px-4 py-2 rounded cursor-not-allowed" : "text-sm font-bold bg-white text-pink-700 px-4 py-2 rounded shadow-sm hover:bg-pink-50 transition";

        document.getElementById('socialProposalsContainer').innerHTML = currentData.map(function(s, i) {
          const actualRank = start + i + 1; 
          const absIndex = start + i;
          const containerId = 'generated-social-' + absIndex;
          
          return '<div class="bg-white p-4 rounded-lg shadow-sm border border-pink-100 flex flex-col space-y-3">' + 
            '<span class="inline-block bg-pink-100 text-pink-800 text-xs font-bold px-3 py-1 rounded self-start">Top ' + actualRank + ' æ¨è–¦ - ' + s.platform + '</span>' + 
            '<p class="text-sm font-bold text-gray-900 leading-relaxed">ğŸª ' + s.hook + '</p>' + 
            '<p class="text-sm text-gray-700 leading-relaxed bg-slate-50 p-2 rounded">' + s.body + '</p>' + 
            '<p class="text-xs text-blue-500 font-bold tracking-wide">' + s.hashtags + '</p>' + 
            '<div class="pt-2 border-t border-pink-50">' + 
              '<button onclick="triggerContentGen(\'social\', ' + absIndex + ', \'' + containerId + '\')" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-bold py-2 px-4 rounded shadow transition w-full md:w-auto">âœ¨ è®“ AI å¹«æˆ‘å¯«é€™å‰‡è²¼æ–‡</button>' + 
            '</div>' + 
            '<div id="' + containerId + '" class="hidden mt-3 trends-panel-wrapper"></div>' + 
          '</div>';
        }).join('');
      }

      function changeSocialPage(direction) {
        const totalPages = Math.ceil(globalSocialData.length / itemsPerPage) || 1;
        currentSocialPage += direction;
        if(currentSocialPage < 1) currentSocialPage = 1;
        if(currentSocialPage > totalPages) currentSocialPage = totalPages;
        renderSocialPage();
      }

      function triggerContentGen(type, index, containerId) {
        const container = document.getElementById(containerId);
        container.classList.remove('hidden');
        
        let colorTheme = type === 'blog' ? 'blue' : 'pink';
        container.innerHTML = '<div class="w-full p-6 flex flex-col items-center justify-center bg-' + colorTheme + '-50/50 rounded-lg border border-' + colorTheme + '-100 shadow-sm"><div class="loader ease-linear rounded-full border-2 border-t-2 border-' + colorTheme + '-500 h-8 w-8 mb-3"></div><span class="text-xs text-' + colorTheme + '-700 font-bold animate-pulse text-center leading-relaxed">AI éˆæ„Ÿæ¹§ç¾ä¸­...<br>æ­£åœ¨ç‚ºæ‚¨æ’°å¯«å®Œæ•´å…§å®¹ï¼Œè«‹ç¨å€™</span></div>';

        const industry = document.getElementById('industry').value;
        const painPoint = document.getElementById('painPoint').value;
        let proposalObj = type === 'blog' ? globalBlogData[index] : globalSocialData[index];

        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'generateActualPost', type, proposalJsonStr: JSON.stringify(proposalObj), industry, painPoint })
        })
        .then(response => response.text())
        .then(function(res) {
          container.innerHTML = '<div class="mt-4 bg-slate-50 p-5 rounded-xl border border-slate-300 flex flex-col space-y-4 shadow-xl relative">' + 
            '<div class="text-sm font-black text-gray-900 border-b border-slate-300 pb-3 flex justify-between items-center sticky top-0 z-10 bg-slate-50">' + 
              '<span>âœï¸ AI ç”Ÿæˆçµæœ</span>' + 
              '<button type="button" onclick="document.getElementById(\'' + containerId + '\').classList.add(\'hidden\');" class="text-xs bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded shadow-sm transition font-bold flex items-center">âœ– æ”¶åˆ</button>' + 
            '</div>' + 
            '<div id="' + containerId + '-content" class="prose prose-sm md:prose-base max-w-none text-gray-800 leading-relaxed bg-white p-4 rounded-lg border border-gray-100">' + res + '</div>' + 
            '<button type="button" onclick="copyGeneratedContent(\'' + containerId + '-content\', this)" class="w-full text-sm bg-indigo-600 text-white hover:bg-indigo-700 py-3 rounded shadow-sm transition font-bold mt-4">ğŸ“‹ è¤‡è£½æ–‡æ¡ˆ</button>' +
            '<button type="button" onclick="document.getElementById(\'' + containerId + '\').classList.add(\'hidden\');" class="w-full text-sm bg-slate-200 text-slate-700 hover:bg-slate-300 py-3 rounded shadow-sm transition font-bold mt-2">âï¸ é—œé–‰é¢æ¿</button>' + 
          '</div>';
        })
        .catch(function(err) {
          container.innerHTML = '<div class="p-3 text-red-500 text-xs font-bold bg-red-50 rounded mt-2 text-center border border-red-200">ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ï¼š' + err.message + '</div>';
        });
      }

      function showError(error) {
        document.getElementById('loading1').classList.add('hidden');
        document.getElementById('loadingGkp').classList.add('hidden');
        document.getElementById('loading2').classList.add('hidden');
        const box = document.getElementById('errorBox');
        box.innerText = "ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š" + (error.message || error);
        box.classList.remove('hidden');
      }

      document.addEventListener('click', function(event) {
        if (event.target.closest('.trends-panel-wrapper') || event.target.closest('button')) {
            return; 
        }
        document.querySelectorAll('.trends-panel-wrapper').forEach(function(panel) {
            panel.classList.add('hidden');
        });
      });

    </script>
  </body>
</html>
